---
interface Props {
	historicalData: string;
}

const { historicalData } = Astro.props;
---

<!-- Wrap the component elements in our custom element “candlestick-chart”. -->
<candlestick-chart data-historical-data={historicalData}>
	<div class="candlestick-chart__wrapper"></div>
</candlestick-chart>

<style lang="scss">
	@use "../../styles/mixins";

	.candlestick-chart__wrapper {
		width: 100%;
		aspect-ratio: 16/9;
		overflow: hidden;
	}
</style>

<script>
	import { createChart } from "lightweight-charts";
	import { mapPriceData, mapVolumeData } from "@utils/map-data.ts";
	import type { PriceData, VolumeData } from "@utils/map-data.ts";

	// Define the behaviour for our new type of HTML element.
	class CandlestickChart extends HTMLElement {
		constructor() {
			super();

			const priceData: PriceData = mapPriceData(
				JSON.parse(this.dataset.historicalData!),
			);

			const volumeData: VolumeData = mapVolumeData(
				JSON.parse(this.dataset.historicalData!),
			);

			const chartWrapper = this.querySelector(".candlestick-chart__wrapper");
			const chart = createChart(chartWrapper as string | HTMLElement, {
				autoSize: true,
				handleScale: false,
				handleScroll: false,
				timeScale: {
					rightOffset: 3,
					timeVisible: true,
				},
			});

			const candlestickSeries = chart.addCandlestickSeries({
				upColor: "#26a69a",
				downColor: "#ef5350",
				borderVisible: false,
				wickUpColor: "#26a69a",
				wickDownColor: "#ef5350",
			});

			candlestickSeries.priceScale().applyOptions({
				scaleMargins: {
					top: 0.1, // highest point of the series will be 10% away from the top
					bottom: 0.2, // lowest point will be 20% away from the bottom
				},
			});
			candlestickSeries.setData(priceData);

			const volumeSeries = chart.addHistogramSeries({
				color: "#26a69a",
				priceFormat: {
					type: "volume",
				},
				priceScaleId: "", // set as an overlay by setting a blank priceScaleId
			});

			volumeSeries.priceScale().applyOptions({
				scaleMargins: {
					top: 0.8, // highest point of the series will be 80% away from the top
					bottom: 0,
				},
			});

			volumeSeries.setData(volumeData);

			chart.timeScale().fitContent();
		}
	}

	// Tell the browser to use our CandlestickChart class for <candlestick-chart> elements.
	customElements.define("candlestick-chart", CandlestickChart);
</script>
